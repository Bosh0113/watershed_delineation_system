<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Prototype System for Basins' Data Using</title>
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/vue.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/iview.css"/>
    <script src="/static/js/iview.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/leaflet.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/leaflet.pm.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/vuescroll.css"/>
    <script src="/static/js/leaflet.js"></script>
    <script src="/static/js/leaflet.pm.min.js"></script>
    <script src="/static/js/axios.min.js"></script>
    <script src="/static/js/vuescroll.js"></script>
    <style>
        body{
            margin: 0px
        }
        .map{
            height: calc(100vh);
        }
        #controllerDiv{
            position: fixed;
            right: 10px;
            bottom: 25px;
            z-index: 999;
            width: 290px;
            height: 90vh;
        }
        .__view{
            display: flex;
            flex-direction: column-reverse;
        }
        .controllerItemDiv{
            background-color:#f0f8ff85;
            margin-top: 10px;
        }
        .basinTypeDiv{
            padding: 0px 0px 0px 15px;
        }
        .basinSelecter{
            width: 100px;
        }
        .divider{
            margin: 5px 0;
            background-color: #96c6f7;
        }
        .basinLabel{
            width: 125px;
        }
        .btnHoverBlue:hover {
            background-color: #2db7f5;
            color: white;
        }
        .clickSwitch{
            margin-left: 5px;
        }
        .queryTypeDiv{
            padding: 0px 0px 0px 15px;
        }
        .uploadGeoJSON{
            border: dashed 0.5px;
            margin-left: 5px;
        }
        .downloadBtn{
            margin-left: 5px;
            width:50px;
        }
        .customDiv{
            text-align: center;
        }
        .customBtn{
            width:250px;
        }
        .showGeoJSONInfoDiv{
            margin-bottom: 5px;
        }
        .geoJSONInfo{
            margin-left: 15px;
            width: 250px;
        }
        .fileBtnHoverRed:hover {
            background-color: #ed4014;
            color: white;
        }
        .removeGeoJSONSelect{
            margin-left: 5px;
        }
        .selectDataDiv{
            padding: 0px 0px 0px 15px;
        }
        .dataTag{
            height: fit-content;
        }
        .runStatusDiv{
            text-align: center;
        }
        .runStatus{
            text-align: left;
        }
        .resetOperationBtn{
            width:350px;
        }
        .customOperationBtn{
            width:350px;
        }
        .removeCustomSelect{
            margin-left: 5px;
        }
        .customFileInput{
            width: 280px;
        }
        .customUploadBtn{
            display: inline-block;
            margin-left: 10px;
        }
    </style>
</head>

<body>
    <div id="vueApp">
        <div class="map" id="leafletMap"></div>
        <div id="controllerDiv">
            <vue-scroll :ops="scrollOps" id="controllerScroll">
                <Card :bordered="false" class='controllerItemDiv'>
                    <strong slot="title">Custom Data Generation</strong>
                    <p>Reset the Parameters of Result Data:</p>
                    <div class="customDiv">
                        <i-button size="small" class="customBtn" type="primary" ghost @click="showResetModal">
                            <p>Setting & Download</p>
                        </i-button>
                        <div>
                            <small>(Use the Data Provided)</small>
                        </div>
                    </div>
                    <Divider size="small" class="divider"></Divider>
                    <p>Use Custom Data for Generation:</p>
                    <div class="customDiv">
                        <i-button size="small" class="customBtn" type="primary" ghost @click="showCustomDataModal">
                            <p>Upload & Setting & Download</p>
                        </i-button>
                    </div>
                </Card>
                <Card :bordered="false" class='controllerItemDiv'>
                    <strong slot="title">Data Service Tools</strong>
                    <span>Query Basin Scope by Click:</span>
                    <i-switch class="clickSwitch" size="large" @on-change="changeQueryBasinBtn" v-model="querySwitch">
                        <Icon slot="open" type="md-pin" size="20"></Icon>
                        <Icon slot="close" type="md-close" size="20"></Icon>
                    </i-switch>
                    <div class="queryTypeDiv">
                        <Radio-group v-model="queryType" @on-change="changeQueryType">
                            <Radio label="standard" class="basinLabel" :disabled = "!querySwitch">
                                <span>Standard Basins</span>
                            </Radio>
                            <i-select class="basinSelecter" v-model="levelSelectQuery" size="small" 
                            :disabled="!(querySwitch&&queryType=='standard')"
                            @on-change="changeQueryBasinsLevel">
                                <i-option v-for="item in levelLayerList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <Radio label="upstream" class="basinLabel" :disabled = "!querySwitch">
                                <span>Whole Upstream of Lakes</span>
                            </Radio>
                            <Radio label="whole" class="basinLabel" :disabled = "!querySwitch">
                                <span>Whole Basins</span>
                            </Radio>
                        </Radio-group>
                    </div>
                    <Divider size="small" class="divider"></Divider>
                    <span>Download Data by Geometry:</span>
                    <div class="basinTypeDiv">
                        <div>
                            <span>Upload Custom Scope:</span>
                            <i-button size="small" type="primary" ghost class="uploadGeoJSON" @click="showUploadGeoJSONModal">
                                <Icon type="ios-cloud-upload" size="15"></Icon>
                                <span>Upload</span>
                            </i-button>
                        </div>
                        <small>(Or Use Existing Geometry on the Map)</small>
                        <div>
                            <span>Select Data to Download:</span>
                            <i-button size="small" type="success" ghost class="downloadBtn" @click="showDownloadModal">
                                <Icon type="md-download" size="20"></Icon>
                            </i-button>
                        </div>
                    </div>
                </Card>
                <Card :bordered="false" class='controllerItemDiv'>
                    <strong slot="title">Data Layers Display</strong>
                    <Checkbox v-model="riverCkb" @on-change="showRiverLayer">Rivers Layer</Checkbox>
                    <Divider size="small" class="divider"></Divider>
                    <Checkbox v-model="basinCkb" @on-change="showBasinsLayer">Basins Layer</Checkbox>
                    <div class="basinTypeDiv">
                        <Radio-group v-model="basinType" @on-change="changeBainsType">
                            <Radio label="standard" class="basinLabel" :disabled = "!basinCkb">
                                <span>Standard Basins</span>
                            </Radio>
                            <i-select class="basinSelecter" v-model="levelSelect" size="small" 
                            :disabled="!(basinCkb&&basinType=='standard')"
                            @on-change="changeStandardBasinsLevel">
                                <i-option v-for="item in levelLayerList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                            <Radio label="custom" class="basinLabel" :disabled = "!basinCkb">
                                <span>Basins & Lakes</span>
                            </Radio>
                            <i-select class="basinSelecter" v-model="levelSelectCustom" size="small" 
                            :disabled="!(basinCkb&&basinType=='custom')"
                            @on-change="changeCustomBasinsLevel">
                                <i-option v-for="item in levelLayerList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                            </i-select>
                        </Radio-group>
                    </div>
                    <Divider size="small" class="divider"></Divider>
                    <Checkbox v-model="wholeUpstreamCkb" @on-change="showWholeUpstreamLayer">Whole Upstream of Lake Layer</Checkbox>
                    <Divider size="small" class="divider"></Divider>
                    <Checkbox v-model="wholeBasinCkb" @on-change="showWholeBasinLayer">Whole Basins Layer</Checkbox>
                </Card>
            </vue-scroll>
        </div>
        <Modal v-model="uploadGeoJSONModal" title="Upload GeoJSON" width="600" draggable>
            <div class="showGeoJSONInfoDiv">
                <span>Selected File:</span>
                <i-input v-model="geoJSONName" readonly class="geoJSONInfo" size="small"></i-input>
                <i-button v-if="geoJSONName!=''" size="small" 
                class="fileBtnHoverRed" id="removeGeoJSONSelect"
                @click="cancelGeoJSONSelect">
                    <Icon type="md-close" size="20"></Icon>
                </i-button>
            </div>
            <Upload :max-size="1024*1024" type="drag" :before-upload="gatherFile" action="-">
                <div style="padding: 20px 0">
                    <Icon type="ios-cloud-upload" size="50" style="color: #3399ff"></Icon>
                    <p>
                        Click or Drag GeoJSON File here to Upload.
                    </p>
                </div>
            </Upload>
            <div slot="footer">
                <i-button @click="uploadGeoJSONModal=false">Cancel</i-button>
                <i-button type="success" @click="uploadGeoJSON()">Upload</i-button>
            </div>
        </Modal>
        <Modal v-model="downloadDataModal" title="Select Data to Download" width="1000" draggable>
            <h4>Basic Data:</h4>
            <div class="selectDataDiv">
                <span>Hydrologically Adjusted Elevations</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadDEM" v-if="!loadingDEM">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">Adjusted elevation is reprepared in 4-byte float (float32). The elevations are adjusted to satisfy the condition 'downstream is not higher than its upstream' while minimizing the required modifications from the original DEM.
                        The elevation above EGM96 geoid is represented in meter, and the vertical increment is set to 10cm. The undefined pixels (oceans) are represented by the value -9999.</Tag>
                <br/>
                <span>Flow Direction</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadDir" v-if="!loadingDir">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">Flow direction is prepared in 1-byte SIGNED integer (int8). The flow direction is represented as follows.
                        1: east, 2: southeast, 4: south, 8: southwest, 16: west, 32: northwest, 64: north. 128: northeast
                        0: river mouth, -1: inland depression, -9: undefined (ocean)
                        NOTE: If a flow direction file is opened as UNSIGNED integer, undefined=247 and inland depression=255.</Tag>
                <br/>
                <span>Upstream Drainage Area (Flow Accumulation Area)</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadAcc" v-if="!loadingAcc">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">Drainage area is reprepared in 4-byte float (float32). The drainage area is represented in km2.
                        The undefined pixels (oceans) are represented by the value -9999.</Tag>
                <br/>
                <span>Lakes (Cite HydroLAKES)</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadLake" v-if="!loadingLake">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">Lakes are in a database aiming to provide the shoreline polygons of all global lakes with a surface area of at least 10 ha.</Tag>
            </div>
            <h4>Product Data:</h4>
            <div class="selectDataDiv">
                <span>Standard Basins</span>
                <i-select class="basinSelecter" v-model="levelSelectDownload" size="small" >
                    <i-option v-for="item in levelLayerList" :value="item.value" :key="item.value">{{ item.label }}</i-option>
                </i-select>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadBasins" v-if="!loadingBasin">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">Basins in Pfafstetter Code System (From level 1 to level 12). 
                    A basin is divided into two sub-basins at every location where two river branches meet which each have an individual upstream area of at least 100 km2.
                </Tag>
                <br/>
                <span>Slope Surface</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadSlopeSurface" v-if="!loadingSlope">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">The slope surface region on which water flow directly into ​​the lake/reservoir after runoff. 
                    In this database, the upstream area of slope surface region is less than 100km2.</Tag>
                <br/>
                <span>Rivers</span>
                <i-button size="small" type="success" ghost class="downloadBtn" @click="downloadRivers" v-if="!loadingRiver">
                    <Icon type="md-download" size="20"></Icon>
                </i-button>
                <i-button v-else loading shape="circle" type="success" ghost size="small"></i-button>
                <br/>
                <Tag class="dataTag" color="cyan">The rivers are definited by threshold from the database of Upstream Drainage Area (Flow Accumulation Area). 
                    In this result database, the upstream area of rivers is less than 100km2. The rivers are represented by the value 1.</Tag>
            </div>
            <div slot="footer">
                <i-button size="small" @click="downloadDataModal=false">Close</i-button>
            </div>
        </Modal>
        <Modal v-model="resetDataModal" title="Reset the Parameters of Result Data" width="450" draggable>
            <i-form ref="resetData" :model="resetData" label-position="top" :rules="resetValidate">
                <Form-item label="River Definition Threshold (Minimal Upstream Area, Unit: km2)">
                    <i-input v-model="resetData.riverThreshold"></i-input>
                </Form-item>
                <Form-item label="Minimal Area of Lakes (Unit: km2)">
                    <i-input v-model="resetData.lakeThreshold"></i-input>
                </Form-item>
            </i-form>
            <div class="runStatusDiv">
                <i-button v-if="resetStatus=='resetSetting'" size="small" class="resetOperationBtn" type="primary" ghost @click="runResetData('resetData')">
                    <p>Run</p>
                </i-button>
                <div v-else-if="resetStatus=='resetRunning'">
                    <i-progress :percent="99.99" status="active" hide-info></i-progress>
                    <span>Running...</span>
                </div>
                <i-button v-else-if="resetStatus=='reset4Download'" size="small" class="resetOperationBtn" type="success" ghost @click="downloadResetData()">
                    <p>Download</p>
                </i-button>
            </div>
            <div slot="footer">
                <i-button size="small" @click="resetDataModal=false">Close</i-button>
            </div>
        </Modal>
        <Modal v-model="customDataModal" title="Use Custom Data for Generation" width="450" draggable>
            <i-form ref="customDataSetting" :model="customDataSetting" label-position="top" :rules="customValidate">
                <Form-item label="DEM (Digital Elevation Model)">
                    <i-input v-model="customDataSetting.demFileName" class="customFileInput"></i-input>
                    <Upload v-if="customDataSetting.demFileName==''" :before-upload="gatherDEM" action="-" class="customUploadBtn">
                        <i-button icon="md-cloud-upload" type="primary" ghost>Select File</i-button>
                    </Upload>
                    <i-button v-else
                    class="fileBtnHoverRed" id="removeCustomSelect"
                    @click="cancelDEMSelect">
                        <Icon type="md-close" size="20"></Icon>
                    </i-button>
                </Form-item>
                <Form-item label="Lakes (format: ESRI Shapefile in Zip file)">
                    <i-input v-model="customDataSetting.lakeZipName" class="customFileInput"></i-input>
                    <Upload v-if="customDataSetting.lakeZipName==''" :before-upload="gatherLakeZip" action="-" class="customUploadBtn">
                        <i-button icon="md-cloud-upload" type="primary" ghost>Select File</i-button>
                    </Upload>
                    <i-button v-else 
                    class="fileBtnHoverRed" id="removeCustomSelect"
                    @click="cancelLakeZipSelect">
                        <Icon type="md-close" size="20"></Icon>
                    </i-button>
                </Form-item>
                <Form-item label="River Definition Threshold (Minimal Upstream Area, Unit: km2)">
                    <i-input v-model="customDataSetting.riverThreshold"></i-input>
                </Form-item>
                <!-- <Form-item label="Minimal Area of Lakes (Unit: km2)">
                    <i-input v-model="customDataSetting.lakeThreshold"></i-input>
                </Form-item> -->
            </i-form>
            <div class="runStatusDiv">
                <i-button v-if="customStatus=='customSetting'" size="small" class="customOperationBtn" type="primary" ghost @click="runCustomData('customDataSetting')">
                    <p>Run</p>
                </i-button>
                <div v-else-if="customStatus=='customRunning'">
                    <i-progress :percent="99.99" status="active" hide-info></i-progress>
                    <span>Running...</span>
                </div>
                <i-button v-else-if="customStatus=='custom4Download'" size="small" class="customOperationBtn" type="success" ghost @click="downloadCustomData()">
                    <p>Download</p>
                </i-button>
            </div>
            <div slot="footer">
                <i-button size="small" @click="customDataModal=false">Close</i-button>
            </div>
        </Modal>
    </div>
    <script>
        var vueApp = new Vue({
            el: "#vueApp",
            created(){
                this.initLevelLabel();
            },
            mounted(){
                this.initMap();
                this.initController();
                this.initLayers();
                this.listenDraw();
            },
            data(){
                return {
                    mapEl: null,
                    baseLayers: null,
                    drawingLayerGroup: null,
                    riverLayer: null,
                    riverCkb: false,
                    basinCkb:false,
                    basinType: 'standard',
                    levelSelect: 1,
                    levelSelectCustom: 1,
                    levelLayerList:[],
                    basinLayer: null,
                    wholeUpstreamLayer:null,
                    lakesLayer:null,
                    wholeBasinLayer: null,
                    wholeBasinCkb:false,
                    wholeUpstreamCkb:false,
                    uploadGeoJSONModal:false,
                    toUploadGeoJSON: null,
                    geoJSONName:"",
                    downloadDataModal:false,
                    levelSelectDownload: 1,
                    loadingDEM:false,
                    loadingDir:false,
                    loadingAcc:false,
                    loadingLake:false,
                    loadingBasin:false,
                    loadingSlope:false,
                    loadingRiver:false,
                    resetDataModal:false,
                    customDataModal:false,
                    querySwitch:false,
                    queryType:"whole",
                    levelSelectQuery:1,
                    resetData:{
                        riverThreshold: 100.0,
                        lakeThreshold: 1000.0
                    },
                    resetValidate:{
                        riverThreshold:[
                            { required: true, message: 'The value cannot be empty', trigger: 'blur' }
                        ],
                        lakeThreshold:[
                            { required: true, message: 'The value cannot be empty', trigger: 'blur' }
                        ]
                    },
                    resetStatus: 'resetSetting',
                    resultDataUrl: '',
                    customDataSetting:{
                        demFileName:'',
                        lakeZipName:'',
                        riverThreshold: 100.0,
                        // lakeThreshold: 1000.0
                    },
                    customValidate:{
                        demFileName:[
                            { required: true, message: 'The file is required', trigger: 'blur' }
                        ],
                        lakeZipName:[
                            { required: true, message: 'The file is required', trigger: 'blur' }
                        ],
                        riverThreshold:[
                            { required: true, message: 'The value cannot be empty', trigger: 'blur' }
                        ],
                        lakeThreshold:[
                            { required: true, message: 'The value cannot be empty', trigger: 'blur' }
                        ]
                    },
                    customStatus: 'customSetting',
                    customDataUrl: '',
                    scrollOps: {
                        bar: {
                            background: "#808695"
                        }
                    },
                }
            },
            methods:{
                initLevelLabel(){
                    for(i=1;i<13;i++){
                        item = {
                            value: i,
                            label: 'level ' + i
                        }
                        this.levelLayerList.push(item);
                    }
                },
                initMap(){
                    this.mapEl = L.map('leafletMap').setView([32.6, 116.6], 10);
                },
                initController(){
                    this.drawingLayerGroup = L.layerGroup([]);
                    this.drawingLayerGroup.addTo(this.mapEl);
                },
                initLayers(){
                    // 图层控件
                    var mapboxVectorMap = 'https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYm9zaDAxMTMiLCJhIjoiY2tsM3FicnprMTMyZTJvbzRpeXF4Y2ZoOSJ9.JFmrSXBF0bTcqyXXnWjLYQ';
                    var vectorMap = L.tileLayer(mapboxVectorMap, { maxZoom: 18 });
                    var vector = L.layerGroup([vectorMap]);

                    
                    var osmVectorMap = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
                    var osmVectorMap = L.tileLayer(osmVectorMap, { maxZoom: 18 });
                    var vectorOSM = L.layerGroup([osmVectorMap]);
                    
                    var tdtImgMap =
                        "http://t0.tianditu.gov.cn/img_w/wmts?tk=d6b0b78f412853967d91042483385d2c" +
                        "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}";
                    var tdtImgAno =
                        "http://t0.tianditu.gov.cn/eia_w/wmts?tk=d6b0b78f412853967d91042483385d2c" +
                        "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=eia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}";
                    var satelliteMap = L.tileLayer(tdtImgMap, {
                        maxZoom: 18,
                        attribution:
                            '&copy; <a href="http://map.tianditu.gov.cn/">tianditu</a> contributors'
                    });
                    var satelliteAno = L.tileLayer(tdtImgAno, { maxZoom: 18 });
                    var satellite = L.layerGroup([satelliteMap, satelliteAno]);

                    var tdtTerrMap =
                        "http://t0.tianditu.com/ter_w/wmts?tk=d6b0b78f412853967d91042483385d2c" +
                        "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=ter&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}";
                    var tdtTerrAno =
                        "http://t0.tianditu.com/eta_w/wmts?tk=d6b0b78f412853967d91042483385d2c" +
                        "&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=eta&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}";
                    var terrainMap = L.tileLayer(tdtTerrMap, {
                        maxZoom: 18,
                        attribution:
                            '&copy; <a href="http://map.tianditu.gov.cn/">tianditu</a> contributors'
                    });
                    var terrainAno = L.tileLayer(tdtTerrAno, { maxZoom: 18 });
                    var terrain = L.layerGroup([terrainMap, terrainAno]);

                    this.baseLayers = {
                        "Mapbox Vector map": vector,
                        "OSM Vector map": vectorOSM,
                        "TDT Satellite map": satellite,
                        "TDT Terrain map": terrain
                    };
                    var overlayLayers = {};
                    L.control.layers(this.baseLayers, overlayLayers).addTo(this.mapEl);
                    this.baseLayers["Mapbox Vector map"].addTo(this.mapEl);
                    
                    // 底图均默认为0层级
                    this.baseLayers["Mapbox Vector map"].setZIndex(0);
                    this.baseLayers["OSM Vector map"].setZIndex(0);
                    this.baseLayers["TDT Satellite map"].setZIndex(0);
                    this.baseLayers["TDT Terrain map"].setZIndex(0);

                    // 比例尺
                    L.control
                        .scale({
                            position: "bottomleft"
                        })
                        .addTo(this.mapEl);

                    // 绘图控件
                    var options = {
                        position: "topleft", // toolbar position, options are 'topleft', 'topright', 'bottomleft', 'bottomright'
                        drawMarker: false, // adds button to draw markers
                        drawPolyline: false, // adds button to draw a polyline
                        drawRectangle: true, // adds button to draw a rectangle
                        drawPolygon: true, // adds button to draw a polygon
                        drawCircle: false, // adds button to draw a cricle
                        cutPolygon: false, // adds button to cut a hole in a polygon
                        editMode: true, // adds button to toggle edit mode for all layers
                        dragMode: false,
                        removalMode: true // adds a button to remove layers
                    };
                    this.mapEl.pm.addControls(options);
                },
                showRiverLayer(show){
                    if(show){
                        // console.log('Show River Layer.');
                        this.riverLayer = L.tileLayer('http://172.21.212.233:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                    }
                    else{
                        // console.log('Hide River Layer.');
                        this.riverLayer.remove();
                    }
                },
                showBasinsLayer(show){
                    if(show){
                        this.changeBainsType();
                    }
                    else{
                        console.log('Hide Basins Layer.');
                        try{
                            this.basinLayer.remove();
                        }catch{}
                    }
                },
                changeBainsType(){
                    switch(this.basinType){
                        case 'standard':{
                            this.changeStandardBasinsLevel();
                            break;
                        }
                        case 'custom':{
                            this.changeCustomBasinsLevel();
                            break;
                        }
                    }
                },
                changeStandardBasinsLevel(){
                    try{
                        this.basinLayer.remove();
                    }catch{}
                    var level = this.levelSelect;
                    // this.basinLayer = L.tileLayer('http://172.21.213.155:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                    console.log('Show Standard Basin Layer in Level ' + level + '.');
                },
                changeCustomBasinsLevel(){
                    try{
                        this.basinLayer.remove();
                    }catch{}
                    var level = this.levelSelectCustom;
                    // this.basinLayer = L.tileLayer('http://172.21.213.155:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                    console.log('Show Basin Layer with Lakes in Level ' + level + '.');
                },
                showWholeUpstreamLayer(show){
                    if(show){
                        console.log('Show Lakes & their Upstream Layer.');
                        // this.lakesLayer = L.tileLayer('http://172.21.213.155:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                        // this.wholeUpstreamLayer = L.tileLayer('http://172.21.213.155:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                    }
                    else{
                        console.log('Hide Lakes & their Upstream Layer.');
                        // this.lakesLayer.remove();
                        // this.wholeUpstreamLayer.remove();
                    }
                },
                showWholeBasinLayer(show){
                    if(show){
                        this.wholeBasinLayer = L.tileLayer('http://172.21.213.155:8085/tile/{z}/{x}/{y}.png').addTo(this.mapEl);
                    }
                    else{
                        this.wholeBasinLayer.remove();
                    }
                },
                changeQueryBasinBtn(state){
                    if(state){
                        console.log('Allow Click Query Scope.');
                        this.changeQueryType();
                    }else{
                        console.log("Stop Click Query Scope.");
                    }
                },
                changeQueryType(){
                    switch(this.queryType){
                        case 'standard':{
                            this.changeQueryBasinsLevel();
                            break;
                        }
                        case 'upstream':{
                            console.log("Query Whole Upstream of Lakes.");
                            break;
                        }
                        case 'whole':{
                            console.log("Query Whole Basins.");
                        }
                    }
                },
                changeQueryBasinsLevel(){
                    console.log("Query Standard Basins in level " + this.levelSelectQuery + ".");
                },
                showUploadGeoJSONModal(){
                    this.toUploadGeoJSON = null;
                    this.geoJSONName = "";
                    this.uploadGeoJSONModal = true;
                },
                gatherFile(file){
                    this.toUploadGeoJSON = file;
                    this.geoJSONName = file.name;
                },
                cancelGeoJSONSelect(){
                    this.toUploadGeoJSON = null;
                    this.geoJSONName = "";
                },
                uploadGeoJSON(){
                    if(this.toUploadGeoJSON != null){
                        this.drawingLayerGroup.clearLayers();
                        var reader = new FileReader();
                        reader.readAsText(this.toUploadGeoJSON);
                        reader.onload = e => {
                            var fileString = e.target.result;
                            this.addGeoJSONToMap(fileString, "blue");
                            this.uploadGeoJSONModal = false;
                        }
                    }
                    else{
                        confirm("No File has be Added.");
                    }
                },
                showDownloadModal(){
                    if(this.drawingLayerGroup.getLayers().length){
                        this.downloadDataModal = true;
                    }
                    else{
                        confirm('Please Give a Scope on Map.');
                    }
                },
                downloadDEM(){
                    this.loadingDEM = true;
                    window.setTimeout(()=>{
                        this.loadingDEM = false;
                        confirm('Download DEM.');
                    }, 3000);
                },
                downloadDir(){
                    this.loadingDir = true;
                    window.setTimeout(()=>{
                        this.loadingDir = false;
                        confirm('Download Dir.');
                    }, 3000);
                },
                downloadAcc(){
                    this.loadingAcc = true;
                    window.setTimeout(()=>{
                        this.loadingDir = false;
                        confirm('Download Acc.');
                    }, 3000);
                },
                downloadLake(){
                    this.loadingLake = true;
                    window.setTimeout(()=>{
                        this.loadingLake = false;
                        confirm('Download Lakes.');
                    }, 3000);
                },
                downloadBasins(){
                    var level = this.levelSelectDownload;
                    this.loadingBasin = true;
                    window.setTimeout(()=>{
                        this.loadingBasin = false;
                        confirm('Download Basins Data in level ' + level + '.');
                    }, 3000);
                },
                downloadSlopeSurface(){
                    this.loadingSlope = true;
                    window.setTimeout(()=>{
                        this.loadingSlope = false;
                        confirm('Download Slope Surface.');
                    }, 3000);
                },
                downloadRivers(){
                    this.loadingRiver = true;
                    window.setTimeout(()=>{
                        this.loadingRiver = false;
                        confirm('Download Rivers.');
                    }, 3000);
                },
                showResetModal(){
                    if(this.drawingLayerGroup.getLayers().length){
                        this.resetStatus="resetSetting";
                        this.resetDataModal = true;
                    }
                    else{
                        confirm('Please Give a Scope on Map.');
                    }
                },
                runResetData(name){
                    this.$refs[name].validate((valid) => {
                        if (valid) {
                            this.$Message.success('Please wait for Data!');
                            this.resetStatus="resetRunning";
                            console.log(this.resetData)
                            window.setTimeout(()=>{
                                this.resetStatus = "reset4Download";
                                this.resultDataUrl="XXX";
                            }, 3000);
                        } else {
                            confirm('Value Can not be Empty.');
                    }});
                },
                downloadResetData(){
                    confirm('Download Reset Data. Url: ' + this.resultDataUrl);
                },
                showCustomDataModal(){
                    this.customDataModal = true;
                    this.customDataSetting.demFileName = "";
                    this.customDataSetting.lakeZipName = "";
                    this.customStatus="customSetting";
                },
                gatherDEM(file){
                    this.customDEMFile = file;
                    this.customDataSetting.demFileName = file.name;
                },
                cancelDEMSelect(){
                    this.customDEMFile = null;
                    this.customDataSetting.demFileName = "";
                },
                gatherLakeZip(file){
                    this.customLakeZip = file;
                    this.customDataSetting.lakeZipName = file.name;
                },
                cancelLakeZipSelect(){
                    this.customLakeZip = null;
                    this.customDataSetting.lakeZipName = "";
                },
                runCustomData(name){
                    this.$refs[name].validate((valid) => {
                        if (valid) {
                            this.$Message.success('Please wait for Data!');
                            this.customStatus="customRunning";
                            console.log(this.customData)
                            window.setTimeout(()=>{
                                this.customStatus = "custom4Download";
                                this.customDataUrl="XXX";
                            }, 3000);
                        } else {
                            confirm('Value Can not be Empty.');
                    }});
                },
                downloadCustomData(){
                    confirm('Download Custom Data. Url: ' + this.customDataUrl);
                },
                addGeoJSONToMap(GeoJSONStr, color){
                    this.drawingLayerGroup.clearLayers();
                    var file = JSON.parse(GeoJSONStr);
                    var geoJsonLayer = L.geoJSON(file, {
                        style: function(feature) {
                            return { color: color };
                        }
                    }).bindPopup(function(layer) {
                        return layer.feature.properties.description;
                    });
                    this.loadFeatures(geoJsonLayer);
                    //平移至数据位置
                    this.mapEl.fitBounds(geoJsonLayer.getBounds());
                },
                loadFeatures(featureCollection) {
                    featureCollection.eachLayer(layer => {
                        this.drawingLayerGroup.addLayer(layer);
                    });
                },
                listenDraw(){
                    var _this = this;
                    this.mapEl.on('pm:create', e=>{
                        _this.drawingLayerGroup.clearLayers();
                        _this.drawingLayerGroup.addLayer(e.layer);
                    });
                    this.mapEl.on('pm:remove', e=>{
                        _this.drawingLayerGroup.clearLayers();
                    });
                    this.mapEl.on('click', e=>{
                        if(_this.querySwitch){
                            var latlng = e.latlng
                            var lon = latlng['lng'];
                            var lat = latlng['lat'];
                            var baseUrl="";
                            switch(_this.queryType){
                                case "standard":{
                                    //各级流域范围接口待补充
                                    baseUrl = "/basins/querySubLevel" + this.levelSelectQuery;
                                    break;
                                }
                                case "upstream":{
                                    //水体上游范围接口待补充
                                    baseUrl = "/basins/upstream";
                                    break;
                                }
                                case "whole":{
                                    //临时写法
                                    baseUrl = "http://localhost:8083/basins/queryScope"
                                }
                            }
                            axios
                            .get(baseUrl + "?lon=" + lon +"&lat=" + lat)
                            .then(res=>{
                                if(res.data !={} && res.data !=0){
                                    var geoFeatrue = res.data;
                                    var tempGeoJSON = {
                                        "type": "FeatureCollection",
                                        "crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },
                                        "features": [geoFeatrue]
                                    }
                                    _this.addGeoJSONToMap(JSON.stringify(tempGeoJSON), "red");
                                }
                                else{
                                    confirm('No Basin Info Here.');
                                };
                            })
                            .catch(err=>{});
                        }
                    });
                },
            }
        })
    </script>
</body>
</html>